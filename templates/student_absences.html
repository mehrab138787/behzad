<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>غیبت دانش‌آموزان</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #f0f2f5; }
h2 { font-weight: 700; margin-bottom: 20px; text-align: center; }
.card { border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); margin-bottom: 12px; transition: 0.3s; }
.card:hover { transform: scale(1.02); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
.accordion-button { font-weight: 600; }
.absence-item { padding: 6px 0; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
.no-absence { color: #888; font-style: italic; padding: 6px 0; }
.form-control, .btn { border-radius: 10px; }
.del-btn { background: none; border: none; color: red; font-size: 18px; cursor: pointer; }
.del-btn:hover { transform: scale(1.2); }

/* Toast */
#toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
</style>
</head>
<body dir="rtl">

<div class="container mt-4">
    <h2>📋 جستجوی غیبت دانش‌آموزان</h2>

    <!-- فرم جستجو -->
    <form method="POST" class="mb-4">
        <div class="row g-2">
            <div class="col-md-5">
                <input type="text" name="search" class="form-control" placeholder="نام یا نام خانوادگی دانش‌آموز..." value="{{ search_query }}">
            </div>
            <div class="col-md-5">
                <input type="text" name="class_name" class="form-control" placeholder="نام کلاس..." value="{{ class_query }}">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100">🔍 جستجو</button>
            </div>
        </div>
    </form>

    {% if student_attendance_list %}
    <div class="accordion" id="studentsAccordion">
        {% for entry in student_attendance_list %}
        {% set student = entry.student %}
        {% set attendances = entry.attendances %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ student.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ student.id }}" aria-expanded="false" aria-controls="collapse{{ student.id }}">
                    {{ student.firstname }} {{ student.lastname }} - کلاس: {{ student.class_.name }} - تعداد غیبت‌ها: {{ attendances|length }}
                </button>
            </h2>
            <div id="collapse{{ student.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ student.id }}" data-bs-parent="#studentsAccordion">
                <div class="accordion-body">
                    {% if attendances %}
                        {% for att in attendances %}
                        <div class="absence-item" data-id="{{ att.id }}">
                            <span>تاریخ: {{ att.date|to_jalali }} - ساعت: {{ att.time.strftime('%H:%M') }}</span>
                            <button class="del-btn" data-id="{{ att.id }}" title="حذف غیبت">✖</button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-absence">هیچ غیبتی ثبت نشده است.</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif search_query or class_query %}
        <p class="text-center text-muted">هیچ دانش‌آموزی با این مشخصات پیدا نشد.</p>
    {% endif %}

    <div class="mt-4 text-center">
        <a href="/" class="btn btn-warning">⬅ بازگشت به صفحه اصلی</a>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Modal تأیید حذف -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">تأیید حذف غیبت</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="بستن"></button>
      </div>
      <div class="modal-body">
        آیا مطمئن هستید که می‌خواهید این غیبت را حذف کنید؟
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">بله، حذف شود</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let deleteId = null;
let deleteBtnEl = null;

function showToast(message, type="success") {
  const container = document.getElementById('toast-container');
  const wrapper = document.createElement('div');
  wrapper.innerHTML = `
    <div class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  const toastEl = wrapper.firstElementChild;
  container.appendChild(toastEl);
  const bsToast = new bootstrap.Toast(toastEl, { delay: 3000 });
  bsToast.show();
  toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

document.addEventListener('DOMContentLoaded', function () {
  // باز کردن مودال هنگام کلیک روی ✖
  document.querySelectorAll('.del-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      deleteId = this.dataset.id;
      deleteBtnEl = this;
      const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
      modal.show();
    });
  });

  // تأیید حذف
  document.getElementById('confirmDelete').addEventListener('click', function(){
    if (!deleteId) return;

    fetch('/delete_absence', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: deleteId })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        deleteBtnEl.closest('.absence-item').remove();
        showToast('✅ غیبت با موفقیت حذف شد', 'success');
      } else {
        showToast('❌ خطا در حذف: ' + (data.error || 'نامشخص'), 'danger');
      }
    })
    .catch(() => {
      showToast('❌ خطای ارتباط با سرور', 'danger');
    });

    // بستن مودال
    const modalEl = document.getElementById('deleteModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
  });
});
</script>
</body>
</html>
