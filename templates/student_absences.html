<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #f0f2f5; }
h2 { font-weight: 700; margin-bottom: 20px; text-align: center; }
.card { border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); margin-bottom: 12px; transition: 0.3s; }
.card:hover { transform: scale(1.02); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
.accordion-button { font-weight: 600; }
.absence-item { padding: 6px 0; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
.no-absence { color: #888; font-style: italic; padding: 6px 0; }
.form-control, .btn { border-radius: 10px; }
.del-btn { background: none; border: none; color: red; font-size: 18px; cursor: pointer; }
.del-btn:hover { transform: scale(1.2); }

/* Toast */
#toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
</style>
</head>
<body dir="rtl">

<div class="container mt-4">
    <h2>ğŸ“‹ Ø¬Ø³ØªØ¬ÙˆÛŒ ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</h2>

    <!-- ÙØ±Ù… Ø¬Ø³ØªØ¬Ùˆ -->
    <form method="POST" class="mb-4">
        <div class="row g-2">
            <div class="col-md-5">
                <input type="text" name="search" class="form-control" placeholder="Ù†Ø§Ù… ÛŒØ§ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²..." value="{{ search_query }}">
            </div>
            <div class="col-md-5">
                <input type="text" name="class_name" class="form-control" placeholder="Ù†Ø§Ù… Ú©Ù„Ø§Ø³..." value="{{ class_query }}">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
            </div>
        </div>
    </form>

    {% if student_attendance_list %}
    <div class="accordion" id="studentsAccordion">
        {% for entry in student_attendance_list %}
        {% set student = entry.student %}
        {% set attendances = entry.attendances %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ student.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ student.id }}" aria-expanded="false" aria-controls="collapse{{ student.id }}">
                    {{ student.firstname }} {{ student.lastname }} - Ú©Ù„Ø§Ø³: {{ student.class_.name }} - ØªØ¹Ø¯Ø§Ø¯ ØºÛŒØ¨Øªâ€ŒÙ‡Ø§: {{ attendances|length }}
                </button>
            </h2>
            <div id="collapse{{ student.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ student.id }}" data-bs-parent="#studentsAccordion">
                <div class="accordion-body">
                    {% if attendances %}
                        {% for att in attendances %}
                        <div class="absence-item" data-id="{{ att.id }}">
                            <span>ØªØ§Ø±ÛŒØ®: {{ att.date|to_jalali }} - Ø³Ø§Ø¹Øª: {{ att.time.strftime('%H:%M') }}</span>
                            <button class="del-btn" data-id="{{ att.id }}" title="Ø­Ø°Ù ØºÛŒØ¨Øª">âœ–</button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-absence">Ù‡ÛŒÚ† ØºÛŒØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif search_query or class_query %}
        <p class="text-center text-muted">Ù‡ÛŒÚ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´Ø®ØµØ§Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</p>
    {% endif %}

    <div class="mt-4 text-center">
        <a href="/" class="btn btn-warning">â¬… Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Modal ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù ØºÛŒØ¨Øª</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
      </div>
      <div class="modal-body">
        Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ØºÛŒØ¨Øª Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ø´ÙˆØ¯</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let deleteId = null;
let deleteBtnEl = null;

function showToast(message, type="success") {
  const container = document.getElementById('toast-container');
  const wrapper = document.createElement('div');
  wrapper.innerHTML = `
    <div class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  const toastEl = wrapper.firstElementChild;
  container.appendChild(toastEl);
  const bsToast = new bootstrap.Toast(toastEl, { delay: 3000 });
  bsToast.show();
  toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

document.addEventListener('DOMContentLoaded', function () {
  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ù‡Ù†Ú¯Ø§Ù… Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ âœ–
  document.querySelectorAll('.del-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      deleteId = this.dataset.id;
      deleteBtnEl = this;
      const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
      modal.show();
    });
  });

  // ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù
  document.getElementById('confirmDelete').addEventListener('click', function(){
    if (!deleteId) return;

    fetch('/delete_absence', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: deleteId })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        deleteBtnEl.closest('.absence-item').remove();
        showToast('âœ… ØºÛŒØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
      } else {
        showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù: ' + (data.error || 'Ù†Ø§Ù…Ø´Ø®Øµ'), 'danger');
      }
    })
    .catch(() => {
      showToast('âŒ Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'danger');
    });

    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
    const modalEl = document.getElementById('deleteModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
  });
});
</script>
</body>
</html>
